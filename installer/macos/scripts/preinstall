#!/bin/bash
# IME Pinyin macOS Pre-Installation Script
#
# This script runs before the package is installed and performs:
# 1. Check system requirements
# 2. Backup user data if upgrading
# 3. Stop any running IME processes

set -e

echo "IME Pinyin Pre-Installation"
echo "==========================="

# Get the current logged-in user
login_user=$(/usr/bin/stat -f%Su /dev/console)
echo "User: ${login_user}"

# Check macOS version (minimum 13.0 Ventura)
os_version=$(sw_vers -productVersion)
major_version=$(echo "${os_version}" | cut -d. -f1)

echo "macOS Version: ${os_version}"

if [ "${major_version}" -lt 13 ]; then
    echo "ERROR: IME Pinyin requires macOS 13.0 (Ventura) or later."
    echo "Your version: ${os_version}"
    exit 1
fi

# Define paths
ime_app_root="/Library/Input Methods/IMEPinyin.app"
user_data_dir="/Users/${login_user}/Library/Rime"
backup_dir="/tmp/ime-pinyin-backup-$(date +%Y%m%d%H%M%S)"

# Stop any running IME process
echo "Stopping existing IME processes..."
/usr/bin/sudo -u "${login_user}" /usr/bin/killall IMEPinyin > /dev/null 2>&1 || true
/usr/bin/sudo -u "${login_user}" /usr/bin/killall Squirrel > /dev/null 2>&1 || true

# Backup user data if exists
if [ -d "${user_data_dir}" ]; then
    echo "Backing up user data to ${backup_dir}..."
    mkdir -p "${backup_dir}"
    cp -R "${user_data_dir}" "${backup_dir}/"
    echo "Backup completed."
fi

echo "Pre-installation completed successfully!"
